- name: Install lazy nginx server
  ansible.builtin.apt:
    name: nginx
    state: present

- name: remove isc-dhcp-defaults
  ansible.builtin.file:
    path: "/etc/default/isc-dhcp-server"
    state: absent

- name: remove old dhcpd.conf
  ansible.builtin.file:
    path: /etc/dhcp/dhcpd.conf
    state: absent

- name: Copy over service defaults
  ansible.builtin.copy:
    src: "{{ playbook_dir }}/pxe/files/etc_default_tftpd-hpa"
    dest: "/etc/default/tftpd-hpa"

- name: Copy over service defaults
  ansible.builtin.copy:
    src: "{{ playbook_dir }}/pxe/files/etc_default_isc-dhcp-server"
    dest: "/etc/default/isc-dhcp-server"

- name: download file
  ansible.builtin.get_url:
    url: "https://download.rockylinux.org/pub/rocky/9/BaseOS/x86_64/os/images/pxeboot/vmlinuz"
    dest: "~"

- name: download file
  ansible.builtin.get_url:
    url: "https://download.rockylinux.org/pub/rocky/9/BaseOS/x86_64/os/images/pxeboot/initrd.img"
    dest: "~"

- name: create tftp root
  ansible.builtin.file:
    path: "/srv/tftp"
    mode: "0755"
    state: directory

- name: ensure rocky9 tftp folder
  ansible.builtin.file:
    path: "/srv/tftp/live/rocky9/fonts"
    mode: "0755"
    recurse: true
    state: directory

- name: download boot files
  ansible.builtin.gut_url:
    url: "{{ rocky_img_url }}/{{ item }}"
    dest: "/srv/tftp/rocky9/{{ item }}"
  loop:
    - vmlinuz
    - initrd.img

- name: download boot files
  ansible.builtin.gut_url:
    url: "{{ rocky_img_url }}/{{ item }}"
    dest: "/srv/tftp/rocky9/{{ item }}"
  loop:
    - vmlinuz
    - initrd.img


      
- name: Configure dhcp.conf
  ansible.builtin.template:
    src: "{{ playbook_dir }}/pxe/templates/pxe_dhcpd.conf.j2"
    dest: "/etc/dhcp/dhcpd.conf"
- name: install packages
  ansible.builtin.apt:
    pkg:
      - zip
      - isc-dhcp-server
      - tftpd-hpa
- name: symlink grubx64.efi
  ansible.builtin.file:
    src: "/srv/tftp/debian-installer/amd64/grubx64.efi"
    dest: "/srv/tftp/grubx64.efi"
    state: link
- name: symlink grubx64.efi
  ansible.builtin.file:
    src: "/srv/tftp/debian-installer/amd64/grub"
    dest: "/srv/tftp/grub"
    state: link
- name: Configure grub.cfg
  ansible.builtin.template:
    src: "{{ playbook_dir }}/rocky/templates/srv_tftp_grub_grub.cfg.j2"
    dest: "/srv/tftp/grub/grub.cfg"
- name: restart PXE services
  ansible.builtin.service:
    name: tftpd-hpa
    state: restarted
- name: restart PXE services
  ansible.builtin.service:
    name: isc-dhcp-server
    state: restarted
